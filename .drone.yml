kind: pipeline
type: docker
name: default

steps:
  - name: auto-tag
    image: alpine/git
    environment:
      GIT_AUTHOR_NAME: drone-ci
      GIT_AUTHOR_EMAIL: drone@example.com
      GIT_TOKEN:
        from_secret: GIT_TOKEN
    commands:
      - |
        git config --global user.name "$GIT_AUTHOR_NAME"
        git config --global user.email "$GIT_AUTHOR_EMAIL"
        git remote set-url origin https://$GIT_TOKEN@github.com/jeremycho-eq4all/cicd.git

        VERSION=$(cat .version)
        MAJOR=$(echo $VERSION | cut -d. -f1)
        MINOR=$(echo $VERSION | cut -d. -f2)


        echo "VERSION: $VERSION"
        echo "MAJOR: $MAJOR"
        echo "MINOR: $MINOR"

        git fetch --tags origin
        LAST_TAG=$(git tag | grep -E "^v${MAJOR}\.${MINOR}\.[0-9]+$" | sort -V | tail -n1)

        BUILD=0
        if [ -n "$LAST_TAG" ]; then
          BUILD=$(echo "$LAST_TAG" | awk -F. '{print $3}')
          BUILD=$((BUILD + 1))
        fi

        NEW_TAG="v${MAJOR}.${MINOR}.${BUILD}"

        # 존재 여부 체크
        if git rev-parse "$NEW_TAG" >/dev/null 2>&1; then
          echo "⚠️ 태그 $NEW_TAG 이미 존재합니다. 스킵합니다."
          exit 0
        fi

        echo "🔖 태그 생성: $NEW_TAG"
        git tag "$NEW_TAG"
        git push origin "$NEW_TAG"
